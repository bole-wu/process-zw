import React from 'react';
import './index.less'; // 改为引入less文件
let chunkdata =  [
                {
                    "condition": [
                        {
                            "field": "(",
                            "operator": null,
                            "datatype": null,
                            "value": null,
                            "comparereuslt": null,
                            "flag": 1,
                            "billtype": null,
                            "relationbilltype": null,
                            "entityName": null
                        },
                        {
                            "field": ")&&(",
                            "operator": null,
                            "datatype": null,
                            "value": null,
                            "comparereuslt": null,
                            "flag": 1,
                            "billtype": null,
                            "relationbilltype": null,
                            "entityName": null
                        },
                        {
                            "field": ")&&(",
                            "operator": null,
                            "datatype": null,
                            "value": null,
                            "comparereuslt": null,
                            "flag": 1,
                            "billtype": null,
                            "relationbilltype": null,
                            "entityName": null
                        },
                        {
                            "field": ")&&(",
                            "operator": null,
                            "datatype": null,
                            "value": null,
                            "comparereuslt": null,
                            "flag": 1,
                            "billtype": null,
                            "relationbilltype": null,
                            "entityName": null
                        },
                        {
                            "field": "#",
                            "operator": "=",
                            "datatype": "String",
                            "value": "N",
                            "comparereuslt": null,
                            "flag": 0,
                            "billtype": "TI6N",
                            "relationbilltype": null,
                            "entityName": null
                        },
                        {
                            "field": ")",
                            "operator": null,
                            "datatype": null,
                            "value": null,
                            "comparereuslt": null,
                            "flag": 1,
                            "billtype": null,
                            "relationbilltype": null,
                            "entityName": null
                        }
                    ],
                    "calculateDesc": "项目信息登记表.估计定价*项目信息登记表.印数+项目信息登记表.印张",
                    "conditionDesc": "Y:Y:Y:N:N:null:null:@TopicslistVO.nprintnum@TI55:项目信息登记表.印数:>:null:1.000:N:null:null:null:2:0:0:;",
                    "calculate": [
                        {
                            "field": "#",
                            "operator": null,
                            "datatype": null,
                            "value": null,
                            "comparereuslt": null,
                            "flag": 0,
                            "billtype": "TI6N",
                            "relationbilltype": null,
                            "entityName": null
                        },
                        {
                            "field": "/",
                            "operator": null,
                            "datatype": null,
                            "value": null,
                            "comparereuslt": null,
                            "flag": 1,
                            "billtype": null,
                            "relationbilltype": null,
                            "entityName": null
                        },
                        {
                            "field": "PlhPresstaskB2VO.iprintunite",
                            "operator": null,
                            "datatype": null,
                            "value": null,
                            "comparereuslt": null,
                            "flag": 0,
                            "billtype": "TI6N",
                            "relationbilltype": null,
                            "entityName": null
                        },
                        {
                            "field": "/2",
                            "operator": null,
                            "datatype": null,
                            "value": null,
                            "comparereuslt": null,
                            "flag": 1,
                            "billtype": null,
                            "relationbilltype": null,
                            "entityName": null
                        },
                        {
                            "field": "*0.156",
                            "operator": null,
                            "datatype": null,
                            "value": null,
                            "comparereuslt": null,
                            "flag": 1,
                            "billtype": null,
                            "relationbilltype": null,
                            "entityName": null
                        }
                    ]
                },
                {
                    "condition": [
                        {
                            "field": "(",
                            "operator": null,
                            "datatype": null,
                            "value": null,
                            "comparereuslt": null,
                            "flag": 1,
                            "billtype": null,
                            "relationbilltype": null,
                            "entityName": null
                        },
                        {
                            "field": ")&&(",
                            "operator": null,
                            "datatype": null,
                            "value": null,
                            "comparereuslt": null,
                            "flag": 1,
                            "billtype": null,
                            "relationbilltype": null,
                            "entityName": null
                        },
                        {
                            "field": ")&&(",
                            "operator": null,
                            "datatype": null,
                            "value": null,
                            "comparereuslt": null,
                            "flag": 1,
                            "billtype": null,
                            "relationbilltype": null,
                            "entityName": null
                        },
                        {
                            "field": ")&&(",
                            "operator": null,
                            "datatype": null,
                            "value": null,
                            "comparereuslt": null,
                            "flag": 1,
                            "billtype": null,
                            "relationbilltype": null,
                            "entityName": null
                        },
                        {
                            "field": "#",
                            "operator": "=",
                            "datatype": "String",
                            "value": "N",
                            "comparereuslt": null,
                            "flag": 0,
                            "billtype": "TI6N",
                            "relationbilltype": null,
                            "entityName": null
                        },
                        {
                            "field": ")",
                            "operator": null,
                            "datatype": null,
                            "value": null,
                            "comparereuslt": null,
                            "flag": 1,
                            "billtype": null,
                            "relationbilltype": null,
                            "entityName": null
                        }
                    ],
                    "calculateDesc": "项目信息登记表.估计定价*项目信息登记表.印数+项目信息登记表.印张",
                    "conditionDesc": "Y:Y:Y:N:N:null:null:@TopicslistVO.nprintnum@TI55:项目信息登记表.印数:>:null:1.000:N:null:null:null:2:0:0:;",
                    "calculate": [
                        {
                            "field": "#",
                            "operator": null,
                            "datatype": null,
                            "value": null,
                            "comparereuslt": null,
                            "flag": 0,
                            "billtype": "TI6N",
                            "relationbilltype": null,
                            "entityName": null
                        },
                        {
                            "field": "/",
                            "operator": null,
                            "datatype": null,
                            "value": null,
                            "comparereuslt": null,
                            "flag": 1,
                            "billtype": null,
                            "relationbilltype": null,
                            "entityName": null
                        },
                        {
                            "field": "PlhPresstaskB2VO.iprintunite",
                            "operator": null,
                            "datatype": null,
                            "value": null,
                            "comparereuslt": null,
                            "flag": 0,
                            "billtype": "TI6N",
                            "relationbilltype": null,
                            "entityName": null
                        },
                        {
                            "field": "/2",
                            "operator": null,
                            "datatype": null,
                            "value": null,
                            "comparereuslt": null,
                            "flag": 1,
                            "billtype": null,
                            "relationbilltype": null,
                            "entityName": null
                        },
                        {
                            "field": "*0.156",
                            "operator": null,
                            "datatype": null,
                            "value": null,
                            "comparereuslt": null,
                            "flag": 1,
                            "billtype": null,
                            "relationbilltype": null,
                            "entityName": null
                        }
                    ]
                }
            ]
class CostCalculator extends React.Component {
    constructor(props) {
        super(props);
        
        // 将chunkdata转换为backendData格式的工具函数
        const convertChunkDataToBackendData = (chunkData) => {
            if (!chunkData || !Array.isArray(chunkData)) return [];
            
            return chunkData.map((item, index) => {
                // 转换条件数组
                const conditionArray = item.condition.map(cond => ({
                    field: cond.field,
                    operator: cond.operator,
                    datatype: cond.datatype,
                    value: cond.value,
                    comparereuslt: cond.comparereuslt,
                    flag: cond.flag,
                    billtype: cond.billtype,
                    relationbilltype: cond.relationbilltype,
                    entityName: cond.entityName
                }));
                
                // 转换计算数组
                const calculateArray = item.calculate.map(calc => ({
                    field: calc.field,
                    operator: calc.operator,
                    datatype: calc.datatype,
                    value: calc.value,
                    comparereuslt: calc.comparereuslt,
                    flag: calc.flag,
                    billtype: calc.billtype,
                    relationbilltype: calc.relationbilltype,
                    entityName: calc.entityName
                }));
                
                return {
                    id: `chunk_${index}`,
                    condition: conditionArray,
                    calculate: calculateArray,
                    conditionDesc: item.conditionDesc || '',
                    calculateDesc: item.calculateDesc || '',
                    fields: []
                };
            });
        };

        // 直接使用文件开头的chunkdata进行转换
        const convertedData = convertChunkDataToBackendData(chunkdata);
        
        this.state = {
            // 使用转换后的数据作为backendData
            backendData: convertedData.length > 0 ? convertedData : [
                // 保留原有的示例数据作为备用
                {
                    "id": "example",
                    "condition": [
                        {
                            "field": "(",
                            "flag": 1
                        },
                        {
                            "field": "#",
                            "operator": ">",
                            "datatype": "Number",
                            "value": "1.000",
                            "flag": 0,
                            "billtype": "TI55"
                        },
                        {
                            "field": ")&&(",
                            "flag": 1
                        },
                        {
                            "field": "#",
                            "operator": "=",
                            "datatype": "String",
                            "value": "N",
                            "flag": 0,
                            "billtype": "TI6N"
                        },
                        {
                            "field": ")",
                            "flag": 1
                        }
                    ],
                    "calculateDesc": "项目信息登记表.估计定价*项目信息登记表.印数+项目信息登记表.印张",
                    "conditionDesc": "Y:Y:Y:N:N:null:null:@TopicslistVO.nprintnum@TI55:项目信息登记表.印数:>:null:1.000:N:null:null:null:2:0:0:;",
                    "calculate": [
                        {
                            "field": "#",
                            "flag": 0,
                            "billtype": "TI6N"
                        },
                        {
                            "field": "/",
                            "flag": 1
                        },
                        {
                            "field": "PlhPresstaskB2VO.iprintunite",
                            "flag": 0,
                            "billtype": "TI6N"
                        },
                        {
                            "field": "/2",
                            "flag": 1
                        },
                        {
                            "field": "*0.156",
                            "flag": 1
                        }
                    ],
                    "fields": []
                }
            ],
            formData: {},
            calculatedResults: {},
            conditionResults: {} // 添加条件结果状态
        };
    }

    // 将服务端数据结构转换为公式展示格式
    parseFormulaToArray = (formulaString, fields) => {
        if (!formulaString) return [];

        const parts = formulaString.split(/([*+\-/()])/g).filter(part => part.trim());
        return parts.map(part => {
            const trimmed = part.trim();
            const field = fields.find(f => f.name === trimmed);

            if (field) {
                return { field: field.name, flag: 0, key: field.key }; // 可编辑字段
            } else {
                return { field: trimmed, flag: 1 }; // 固定运算符
            }
        });
    };

    // 将服务端数据结构转换为条件公式展示格式
    parseConditionToArray = (conditionString) => {
        if (!conditionString) return [];

        const parts = conditionString.split(/([><=+\-*/()?:\s])/g).filter(part => part.trim());
        return parts.map(part => {
            const trimmed = part.trim();
            if (/^[><=+\-*/()?:]$/.test(trimmed)) {
                return { field: trimmed, flag: 1 }; // 运算符
            } else if (/^\d+$/.test(trimmed)) {
                return { field: trimmed, flag: 1 }; // 数字
            } else {
                return { field: trimmed, flag: 0 }; // 变量
            }
        });
    };

    // 渲染公式展示
    renderFormulaDisplay = (formulaArray, itemId, prefix) => {
        return (
            <div className="formula-row">
                {formulaArray.map((part, index) => {
                    if (part.flag === 0) {
                        // 可编辑字段
                        const fieldKey = `${prefix}_${itemId}_${part.key || index}`;
                        return (
                            <input
                                key={`${prefix}-${itemId}-${index}`}
                                type={part.type === 'select' ? 'select' : 'number'}
                                className="formula-input"
                                placeholder={part.name || part.field}
                                value={this.state.formData[fieldKey] || ''}
                                onChange={(e) => this.handleFieldChange(e, fieldKey)}
                            />
                        );
                    } else {
                        // 固定运算符或数字
                        return (
                            <span key={`${prefix}-${itemId}-${index}`} className="formula-operator">
                                {part.field}
                            </span>
                        );
                    }
                })}
            </div>
        );
    };

    // 检查条件是否满足
    checkCondition = (index, item) => {
        try {
            let conditionExpression = '';
            
            item.condition.forEach((part, partIndex) => {
                if (part.flag === 0) {
                    // 可编辑字段，从formData中获取值
                    const fieldKey = `condition_${index}_${partIndex}`;
                    const value = this.state.formData[fieldKey] || part.value || 0;
                    
                    // 根据数据类型处理值
                    let processedValue = value;
                    if (part.datatype === 'Number') {
                        processedValue = parseFloat(value) || 0;
                    } else if (part.datatype === 'String') {
                        processedValue = `"${value}"`;
                    }
                    
                    conditionExpression += processedValue;
                } else {
                    // 固定运算符
                    conditionExpression += part.field;
                }
            });

            // 计算条件结果
            const conditionResult = eval(conditionExpression);
            
            // 保存条件结果到state
            this.setState(prevState => ({
                conditionResults: {
                    ...prevState.conditionResults,
                    [index]: conditionResult ? '条件满足' : '条件不满足'
                }
            }));
            
            return conditionResult;
        } catch (error) {
            this.setState(prevState => ({
                conditionResults: {
                    ...prevState.conditionResults,
                    [index]: '条件错误'
                }
            }));
            return false;
        }
    };

    // 计算结果（只有在条件满足时才计算）
    calculateResult = (index, item) => {
        try {
            let calculateExpression = '';
            item.calculate.forEach((part, partIndex) => {
                if (part.flag === 0) {
                    const fieldKey = `calculate_${index}_${partIndex}`;
                    const value = this.state.formData[fieldKey] || part.value || 0;
                    calculateExpression += value;
                } else {
                    calculateExpression += part.field;
                }
            });

            // 计算结果
            const calculateResult = eval(calculateExpression);
            
            this.setState(prevState => ({
                calculateResults: {
                    ...prevState.calculateResults,
                    [index]: calculateResult
                }
            }));
        } catch (error) {
            this.setState(prevState => ({
                calculateResults: {
                    ...prevState.calculateResults,
                    [index]: '计算错误'
                }
            }));
        }
    };

    // 完整的计算流程
    calculateResults = (index, item) => {
        // 先检查条件
        const conditionMet = this.checkCondition(index, item);
        
        // 如果条件满足，再计算结果
        if (conditionMet) {
            this.calculateResult(index, item);
        } else {
            // 条件不满足时，清空计算结果
            this.setState(prevState => ({
                calculateResults: {
                    ...prevState.calculateResults,
                    [index]: '条件不满足'
                }
            }));
        }
    };



    // 处理输入变化 - 自动触发计算
    handleInputChange = (fieldName, value) => {
        this.setState(prevState => ({
            formData: {
                ...prevState.formData,
                [fieldName]: value
            }
        }), () => {
            // 在状态更新后自动计算所有公式
            this.autoCalculateAll();
        });
    };

    // 自动计算所有公式
    autoCalculateAll = () => {
        this.state.backendData.forEach((item, index) => {
            this.calculateResults(index, item);
        });
    };

    componentDidMount() {
        // 初始化一些默认值
        const initialFormData = {};
        this.state.backendData.forEach((item, index) => {
            item.condition.forEach((part, partIndex) => {
                if (part.flag === 0 && part.value) {
                    initialFormData[`condition_${index}_${partIndex}`] = part.value;
                }
            });
            item.calculate.forEach((part, partIndex) => {
                if (part.flag === 0 && part.value) {
                    initialFormData[`calculate_${index}_${partIndex}`] = part.value;
                }
            });
        });

        this.setState({ formData: initialFormData }, () => {
            // 初始化完成后自动计算所有公式
            this.autoCalculateAll();
        });
    }

    handleFieldChange = (e, fieldKey) => {
        const { value } = e.target;
        this.setState(prevState => ({
            formData: {
                ...prevState.formData,
                [fieldKey]: value
            }
        }));
    };

    render() {
        const { backendData, formData, calculatedResults, conditionResults } = this.state;

        return (
            <div className="cost-calculator">
                <div className="content-wrapper">
                    {backendData.map((item, index) => (
                        <div key={index} className="calculation-card">
                            <div className="card-content">
                                {/* 条件公式说明 */}
                                <div className="formula-row">
                                    <h4 className="description-title">条件公式说明</h4>
                                    <div className="description-content">{item.conditionDesc}</div>
                                </div>

                                {/* 条件公式 */}
                                <div className="formula-row">
                                    <h4 className="formula-title">条件公式</h4>
                                    <div className="formula-row-container">
                                        {item.condition.map((part, partIndex) => {
                                            if (part.flag === 0) {
                                                // 可编辑字段
                                                const fieldKey = `condition_${index}_${partIndex}`;
                                                return (
                                                    <input
                                                        key={`condition-${index}-${partIndex}`}
                                                        type="text"
                                                        className="formula-input"
                                                        placeholder={part.field}
                                                        value={formData[fieldKey] || ''}
                                                        onChange={(e) => this.handleInputChange(fieldKey, e.target.value)}
                                                    />
                                                );
                                            } else {
                                                // 固定运算符
                                                return (
                                                    <span key={`condition-${index}-${partIndex}`} className="formula-operator">
                                                        {part.field}
                                                    </span>
                                                );
                                            }
                                        })}
                                    </div>
                                </div>

                                {/* 条件结果 */}
                                <div className="formula-row">
                                    <h4 className="result-title">条件结果</h4>
                                    <div className="result-value">
                                        {conditionResults[index] || "等待条件判断..."}
                                    </div>
                                </div>

                                {/* 计算公式说明 */}
                                <div className="formula-row">
                                    <h4 className="description-title">计算公式说明</h4>
                                    <div className="description-content">{item.calculateDesc}</div>
                                </div>

                                {/* 计算公式 */}
                                <div className="formula-row">
                                    <h4 className="formula-title">计算公式</h4>
                                    <div className="formula-row-container">
                                        {item.calculate.map((part, partIndex) => {
                                            if (part.flag === 0) {
                                                // 可编辑字段
                                                const fieldKey = `calculate_${index}_${partIndex}`;
                                                return (
                                                    <input
                                                        key={`calculate-${index}-${partIndex}`}
                                                        type="text"
                                                        className="formula-input"
                                                        placeholder={part.field}
                                                        value={formData[fieldKey] || ''}
                                                        onChange={(e) => this.handleInputChange(fieldKey, e.target.value)}
                                                    />
                                                );
                                            } else {
                                                // 固定运算符
                                                return (
                                                    <span key={`calculate-${index}-${partIndex}`} className="formula-operator">
                                                        {part.field}
                                                    </span>
                                                );
                                            }
                                        })}
                                    </div>
                                </div>

                                {/* 计算结果 */}
                                <div className="formula-row">
                                    <h4 className="result-title">计算结果</h4>
                                    <div className="result-value">
                                        {conditionResults[index] === '条件不满足' 
                                            ? '条件不满足'
                                            : calculatedResults[index] || "等待计算..."}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );
    }
}

export default CostCalculator;